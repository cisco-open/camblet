---
title: 'Try on VM'
description: 'Your first zero trust networking environment'
sidebar:
  order: 2
---

This guide will walk you through a basic Camblet scenario.
It will deploy Camblet into the kernel to assign strong identities to processes and transparently establish mTLS connections.
Simple NGINX server with cURL will be used for demostration.

### Prerequisites

> This guide assumes the existance of a Lima instance called `quickstart` with Camblet installed.
> It can be created following the [installation guide](/docs/start/installation).

In this scenario there will be a nginx server which will work as an echo server.
On client side cURL will be used.
All commands must be run inside the virtual machine. To return to Lima:

```sh
limactl shell quickstart
```

Install nginx server:

```sh
sudo apt install nginx -y
```

### Configure agent

Camblet consist of two building blocks:

- Kernel module: Handles transparent TLS and enforces policies.
- Agent: Issues certificates and collects metadata for processes.

The agent configuration resides in `/etc/camblet/config.yaml`.

By default, it looks like this:

```yaml
agent:
  trustDomain: acme.corp
  defaultCertTTL: 2h
  metadataCollectors:
    procfs:
      enabled: true
      extractEnvs: false
    linuxos:
      enabled: true
    sysfsdmi:
      enabled: true
    azure:
      enabled: false
    ec2:
      enabled: false
    gcp:
      enabled: false
    kubernetes:
      enabled: false
    docker:
      enabled: false
```

In this file, the agent can be configured to use a trust domain of your choice, along with the certificate time-to-live (certTTL).
Camblet support various [metadata sources](/docs/concepts/process-metadata), those can be configured under the `metadataCollectors` block.
Camblet can utilize metadata from these sources to identify processes and enforce policies. The [procfs](/docs/concepts/process-metadata#proc-fs), [linuxos](/docs/concepts/process-metadata#linux-os), and [sysfsdmi](/docs/concepts/process-metadata#sys-fs-dmi) are enabled by default.

Let's gather metadata for the NGINX web server that was just installed.

```sh
$ camblet agent augment $(pidof nginx)

# Sample output

linuxos:kernel:release:linux-6.5.0-14-generic
linuxos:kernel:version:#14-Ubuntu SMP PREEMPT_DYNAMIC Tue Nov 14 14:59:49 UTC 2023
linuxos:name:ubuntu
linuxos:version:Ubuntu 23.10
process:cmdline:nginx: worker process
process:gid:33
process:gid:additional:33
process:gid:effective:33
process:gid:real:33
process:name:nginx
process:pid:3731
process:uid:33
process:uid:effective:33
process:uid:real:33
sysfsdmi:bios:date:03/01/2023
sysfsdmi:bios:release:0.0
sysfsdmi:bios:vendor:EDK II
sysfsdmi:bios:version:edk2-stable202302-for-qemu
sysfsdmi:chassis:type:1
sysfsdmi:chassis:vendor:QEMU
sysfsdmi:chassis:version:pc-q35-8.2
sysfsdmi:product:name:Standard PC (Q35 + ICH9, 2009)
sysfsdmi:product:version:pc-q35-8.2
```

The command prints out every available metadata for the specified process. These metadata can be used in [policies](/docs/concepts/policy) to describe identities and related parameters.

### Create policy for NGINX

The policy can be written by hand, but the Camblet CLI can do the work for you with the `generate-policy` command. There are two mandatory
parameters, the PID of the process and the workload ID.

First, determine the process ID of NGINX by using the following command:

```sh
$ pidof -s nginx

# Sample output

5241
```

Next, run the Camblet CLI to generate a policy and save it into the default policy directory as nginx.yaml.

```sh
sudo camblet agent generate-policy 5241 nginx | sudo tee /etc/camblet/policies/nginx.yaml
```

**Generated policy**

```yaml
- certificate:
    ttl: 86400s
    workloadID: nginx
  connection:
    mtls: STRICT
  selectors:
  - process:binary:path: /usr/sbin/nginx
    process:gid: "33"
    process:name: nginx
    process:uid: "33"
```

> The saved policy file is automatically read by the running Camblet agent and gets updated within the kernel.

Camblet will use the `selectors` to identify the NGINX server. The `connection` part configures the TLS settings where `STRICT` mTLS value means only clients with trusted certificates can communicate with it.

To verify that, let's try connecting to NGINX with cURL.

```sh
$ curl localhost

curl: (56) Recv failure: Connection reset by peer
```

### Create policy for cURL

To create a new policy for cURL to communicate with the server, we need the PID of cURL. Since cURL is not running continuously like the server, a "dummy" command is needed to force it to run until generate the policy.

```sh
$ curl 1.2.3.4 &

[1] 5966
```

Let's generate configuration for cURL

`This must be done before cURL times out and the process terminates.`

```sh
sudo camblet agent generate-policy 5966 curl | sudo tee /etc/camblet/policies/curl-simple.yaml
- certificate:
    ttl: 86400s
    workloadID: curl
  connection:
    mtls: STRICT
  selectors:
  - process:binary:path: /usr/bin/curl
    process:gid: "1000"
    process:name: curl
    process:uid: "501"
```

### Try to connect to nginx with a certificate

Using this policy, cURL gets an identity and will use mTLS. Let's try to communicate with the nginx once again.

```bash
$ curl localhost:80

curl: (56) Recv failure: Connection reset by peer
```

It still doesn't work, one last piece of the puzzle is missing. Camblet must ascertain the target destination for the application of policies.
Enforcing policies on every egress connection implies that cURL won't be able to reach destinations beyond the Camblet-managed environment.
Services has to be registered into the [service registry](/docs/concepts/service-registry) through service definitions.

**Sample Service discovery configuration file**

```sh
- addresses:
  - address: localhost
    port: 80
  labels:
    app:label: app
```

Let's ignore the labels part for now; it is meant for more advanced configuration.
The `addresses` section specifies the registered destination addresses to which the policies should be applied.

Let's create our own `services.yaml` where we place the nginx server's service IP and port number.

```sh
sudo tee /etc/camblet/services/local.yaml >/dev/null <<EOF
- addresses:
  - address: 127.0.0.1
    port: 80
  labels:
    app:label: nginx
EOF
```

### Try to connect to nginx with certificate and configured Camblet

With the service registry entry for NGINX in place, let's check if its indeed fixed the error.

```sh
$ curl localhost

<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

It finally works.
